<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ¨èç³»ç»Ÿ - åŸºäºç‰¹å¾çš„ç²¾å‡†åŒ¹é…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .workflow-step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .workflow-step h2 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .workflow-step h2 .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 16px;
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #34a853;
            color: white;
        }

        .btn-success:hover {
            background: #2d8e47;
        }

        .customer-profile {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .profile-item {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 8px;
        }

        .profile-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .profile-value {
            font-size: 22px;
            font-weight: bold;
            word-break: break-all;
            line-height: 1.3;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .product-card.high-match {
            border-color: #34a853;
        }

        .product-card.medium-match {
            border-color: #fbbc04;
        }

        .product-card.low-match {
            border-color: #ea4335;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .product-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .match-score {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .product-category {
            display: inline-block;
            padding: 3px 10px;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .match-reason {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .feedback-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .feedback-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .feedback-btn:hover {
            transform: translateY(-2px);
        }

        .feedback-btn.selected-positive {
            background: #34a853;
            color: white;
            border-color: #34a853;
        }

        .feedback-btn.selected-negative {
            background: #ea4335;
            color: white;
            border-color: #ea4335;
        }

        .sample-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: bold;
        }

        .positive-sample {
            background: #d4edda;
            color: #155724;
        }

        .negative-sample {
            background: #f8d7da;
            color: #721c24;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .analysis-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .analysis-label {
            color: #666;
            font-size: 0.9em;
        }

        .strategy-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .next-steps {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
            margin-top: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .tabs {
            display: flex;
            margin: 20px 0;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .feature-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 0.8em;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>ğŸ¯ æ™ºèƒ½æ¨èç³»ç»Ÿ</h1>
            <p>åŸºäºå®¢æˆ·ç‰¹å¾çš„ç²¾å‡†äº§å“åŒ¹é…ä¸å­¦ä¹ ä¼˜åŒ–</p>
        </div>

        <div class="content">
            <!-- æ­¥éª¤1ï¼šå®¢æˆ·æœç´¢ä¸ç”»åƒåˆ†æ -->
            <div class="workflow-step">
                <h2><span class="step-number">1</span> å®¢æˆ·ç”»åƒåˆ†æ</h2>
                <div class="search-box">
                    <input type="text" id="customerId" class="search-input"
                           placeholder="è¾“å…¥å®¢æˆ·å·"
                           value="CDB91DCCE198B10A522FE2AABF6A8D81">
                    <button class="btn btn-primary" onclick="analyzeCustomer()">åˆ†æå®¢æˆ·</button>
                </div>
                <div id="customerProfile"></div>
            </div>

            <!-- æ­¥éª¤2ï¼šæ™ºèƒ½æ¨èåŒ¹é… -->
            <div class="workflow-step">
                <h2><span class="step-number">2</span> æ™ºèƒ½äº§å“æ¨è</h2>
                <p style="color: #666; margin-bottom: 15px;">
                    åŸºäºå®¢æˆ·å¹´é¾„ã€é£é™©åå¥½ã€è´¢å¯Œæ°´å¹³ç­‰ç‰¹å¾ï¼Œæ™ºèƒ½åŒ¹é…æœ€åˆé€‚çš„äº§å“
                </p>
                <div id="recommendations" class="loading">ç­‰å¾…å®¢æˆ·åˆ†æ...</div>
            </div>

            <!-- æ­¥éª¤3ï¼šæ ·æœ¬æ”¶é›† -->
            <div class="workflow-step">
                <h2><span class="step-number">3</span> æ­£è´Ÿæ ·æœ¬æ ‡è®°</h2>
                <p style="color: #666; margin-bottom: 15px;">
                    è¯·æ ‡è®°æ¯ä¸ªäº§å“ï¼šğŸ˜Š æ„Ÿå…´è¶£ = æ­£æ ·æœ¬ï¼ŒğŸ˜• ä¸æ„Ÿå…´è¶£ = è´Ÿæ ·æœ¬
                </p>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="collectSamples()"
                            style="font-size: 18px; padding: 15px 40px;">
                        æ”¶é›†æ ·æœ¬å¹¶åˆ†æç­–ç•¥
                    </button>
                </div>
                <div id="sampleStatus"></div>
            </div>

            <!-- åˆ†æç»“æœæ ‡ç­¾é¡µ -->
            <div id="analysisSection" style="display: none;">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('sample', this)">æ ·æœ¬åˆ†æ</div>
                    <div class="tab" onclick="showTab('strategy', this)">ç­–ç•¥åˆ†æ</div>
                    <div class="tab" onclick="showTab('accuracy', this)">å‡†ç¡®ç‡æå‡</div>
                    <div class="tab" onclick="showTab('nextstep', this)">ä¸‹ä¸€æ­¥æ¨è</div>
                </div>

                <!-- æ ·æœ¬åˆ†æ -->
                <div id="sample" class="tab-content active">
                    <h3>ğŸ“Š æ ·æœ¬ç»Ÿè®¡åˆ†æ</h3>
                    <div id="sampleAnalysis"></div>
                </div>

                <!-- ç­–ç•¥åˆ†æ -->
                <div id="strategy" class="tab-content">
                    <h3>ğŸ“ˆ ç­–ç•¥è°ƒæ•´å»ºè®®</h3>
                    <div id="strategyAnalysis"></div>
                </div>

                <!-- å‡†ç¡®ç‡æå‡ -->
                <div id="accuracy" class="tab-content">
                    <h3>ğŸ¯ å‡†ç¡®ç‡æå‡åˆ†æ</h3>
                    <div id="accuracyAnalysis"></div>
                </div>

                <!-- ä¸‹ä¸€æ­¥æ¨è -->
                <div id="nextstep" class="tab-content">
                    <h3>ğŸš€ ä¸‹ä¸€æ­¥æ¨èç­–ç•¥</h3>
                    <div style="margin: 20px 0;">
                        <button id="getNextRecommendationsBtn" onclick="getNextStepRecommendations()"
                                class="btn-primary" style="font-size: 18px; padding: 12px 30px;">
                            ğŸ¯ è·å–æ–°äº§å“æ¨è
                        </button>
                        <p style="color: #666; margin-top: 10px;">åŸºäºæ‚¨çš„åé¦ˆå†å²ï¼Œæ¨èæ•°æ®åº“ä¸­çš„å…¶ä»–äº§å“</p>
                    </div>
                    <div id="nextStepAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentCustomer = null;
        let currentRecommendations = null;
        let selectedFeedback = [];

        // åˆ†æå®¢æˆ·
        async function analyzeCustomer() {
            const customerId = document.getElementById('customerId').value;
            if (!customerId) {
                alert('è¯·è¾“å…¥å®¢æˆ·å·');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/customers/${customerId}`);
                const data = await response.json();

                currentCustomer = data.customer;
                currentRecommendations = data.recommendations;

                // æ˜¾ç¤ºå®¢æˆ·ç”»åƒ
                displayCustomerProfile(data.customer, data.customerInsight);

                // æ˜¾ç¤ºæ¨è
                displayRecommendations(data.recommendations);

            } catch (error) {
                alert('åˆ†æå¤±è´¥: ' + error.message);
                console.error(error);
            }
        }

        // æ˜¾ç¤ºå®¢æˆ·ç”»åƒ
        function displayCustomerProfile(customer, insight) {
            const profileDiv = document.getElementById('customerProfile');

            profileDiv.innerHTML = `
                <div class="customer-profile">
                    <h3>å®¢æˆ·ç”»åƒ</h3>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <div class="profile-label">å®¢æˆ·å·</div>
                            <div class="profile-value">${customer.cust_no}</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">å¹´é¾„</div>
                            <div class="profile-value">${customer.age}å²</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">é£é™©åå¥½</div>
                            <div class="profile-value">${insight.riskLevel}</div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-label">é€‚åˆç±»åˆ«</div>
                            <div class="profile-value">${insight.suitableCategories.join(', ')}</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <strong>æŠ•èµ„å»ºè®®ï¼š</strong> ${insight.recommendation}
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ¨è
        function displayRecommendations(recommendations) {
            const recDiv = document.getElementById('recommendations');

            let html = '<div class="recommendation-grid">';

            recommendations.forEach((product, index) => {
                const strengthClass = product.recommendationStrength === 'strong' ? 'high-match' :
                                     product.recommendationStrength === 'medium' ? 'medium-match' : 'low-match';

                const strengthText = product.recommendationStrength === 'strong' ? 'é«˜åŒ¹é…' :
                                   product.recommendationStrength === 'medium' ? 'ä¸­åŒ¹é…' : 'ä½åŒ¹é…';

                html += `
                    <div class="product-card ${strengthClass}">
                        <div class="product-header">
                            <div>
                                <div class="product-name">${product.name}</div>
                                <div class="product-category">${product.category}</div>
                            </div>
                            <div class="match-score">${product.matchScore.toFixed(0)}åˆ†</div>
                        </div>
                        <div class="match-reason">${product.matchReason}</div>
                        <div>
                            ${product.features.map(f => `<span class="feature-tag">${f}</span>`).join('')}
                        </div>
                        <div class="feedback-section">
                            <button class="feedback-btn" onclick="selectFeedback(${index}, 'positive')">
                                ğŸ˜Š æ„Ÿå…´è¶£<br><small>æ­£æ ·æœ¬</small>
                            </button>
                            <button class="feedback-btn" onclick="selectFeedback(${index}, 'negative')">
                                ğŸ˜• ä¸æ„Ÿå…´è¶£<br><small>è´Ÿæ ·æœ¬</small>
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            recDiv.innerHTML = html;
        }

        // é€‰æ‹©åé¦ˆ
        function selectFeedback(index, type) {
            // æ¸…é™¤è¯¥äº§å“çš„æ‰€æœ‰é€‰æ‹©
            const buttons = document.querySelectorAll('.product-card')[index].querySelectorAll('.feedback-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected-positive', 'selected-negative');
            });

            // é€‰ä¸­å½“å‰æŒ‰é’®
            if (type === 'positive') {
                buttons[0].classList.add('selected-positive');
                selectedFeedback[index] = {
                    productId: currentRecommendations[index].id,
                    productName: currentRecommendations[index].name,
                    feedback: 'interested',
                    label: 1
                };
            } else {
                buttons[1].classList.add('selected-negative');
                selectedFeedback[index] = {
                    productId: currentRecommendations[index].id,
                    productName: currentRecommendations[index].name,
                    feedback: 'not_interested',
                    label: 0
                };
            }
        }

        // æ”¶é›†æ ·æœ¬
        async function collectSamples() {
            const feedback = selectedFeedback.filter(f => f);

            if (feedback.length === 0) {
                alert('è¯·è‡³å°‘æ ‡è®°ä¸€ä¸ªäº§å“');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/customers/${currentCustomer.cust_no}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback })
                });

                const data = await response.json();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                document.getElementById('sampleStatus').innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… æ ·æœ¬æ”¶é›†æˆåŠŸï¼</strong><br>
                        æ­£æ ·æœ¬: ${data.samples.positiveSamples} | è´Ÿæ ·æœ¬: ${data.samples.negativeSamples}
                    </div>
                `;

                // æ˜¾ç¤ºåˆ†æåŒºåŸŸ
                document.getElementById('analysisSection').style.display = 'block';

                // æ›´æ–°å„æ ‡ç­¾é¡µå†…å®¹
                updateSampleAnalysis(data.sampleAnalysis);
                updateStrategyAnalysis(data.strategyAnalysis);
                updateAccuracyAnalysis(data.accuracyImprovement);
                updateNextStepAnalysis(data.nextStepStrategy);

                // è‡ªåŠ¨åˆ‡æ¢åˆ°æ ·æœ¬åˆ†ææ ‡ç­¾
                showTab('sample', document.querySelector('.tab'));

            } catch (error) {
                alert('æäº¤å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }

        // æ›´æ–°æ ·æœ¬åˆ†æ
        function updateSampleAnalysis(data) {
            const div = document.getElementById('sampleAnalysis');

            let html = `
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <div class="analysis-value">${data.totalSamples}</div>
                        <div class="analysis-label">æ€»æ ·æœ¬æ•°</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-value">${data.positiveRatio}</div>
                        <div class="analysis-label">æ­£æ ·æœ¬æ¯”ä¾‹</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-value">${data.negativeRatio}</div>
                        <div class="analysis-label">è´Ÿæ ·æœ¬æ¯”ä¾‹</div>
                    </div>
                </div>
            `;

            html += '<h4 style="margin-top: 30px;">äº§å“ç±»åˆ«åå¥½</h4>';
            Object.entries(data.categoryPreferences).forEach(([category, stats]) => {
                const ratio = stats.positive / (stats.positive + stats.negative) * 100;
                html += `
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${category}</span>
                            <span>${ratio.toFixed(1)}% å¥½æ„Ÿåº¦</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${ratio}%"></div>
                        </div>
                    </div>
                `;
            });

            html += '<h4 style="margin-top: 30px;">æ´å¯Ÿ</h4>';
            html += '<ul style="color: #666;">';
            data.insights.forEach(insight => {
                html += `<li>${insight}</li>`;
            });
            html += '</ul>';

            div.innerHTML = html;
        }

        // æ›´æ–°ç­–ç•¥åˆ†æ
        function updateStrategyAnalysis(data) {
            const div = document.getElementById('strategyAnalysis');

            div.innerHTML = `
                <div class="strategy-box">
                    <h4>å®¢æˆ·åå¥½åˆ†æ</h4>
                    <p style="font-size: 1.1em; margin: 15px 0;">
                        å®¢æˆ·è¡¨ç°ï¼š<strong>${data.customerPreference}</strong>
                    </p>
                    <div style="margin: 20px 0;">
                        <div>ç­–ç•¥å¾—åˆ†</div>
                        <div class="progress-bar" style="height: 30px;">
                            <div class="progress-fill" style="width: ${data.strategyScore}%; line-height: 30px; text-align: center;">
                                ${data.strategyScore}/100
                            </div>
                        </div>
                    </div>
                    <p><strong>å»ºè®®ï¼š</strong>${data.recommendationAdjustment}</p>
                </div>

                <div class="next-steps">
                    <h4>ä¸‹ä¸€æ­¥è¡ŒåŠ¨</h4>
                    <p>${data.nextRecommendation}</p>
                </div>
            `;
        }

        // æ›´æ–°å‡†ç¡®ç‡åˆ†æ
        function updateAccuracyImprovement(data) {
            const div = document.getElementById('accuracyAnalysis');

            div.innerHTML = `
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <div class="analysis-value">${data.step1_accuracy}</div>
                        <div class="analysis-label">åˆå§‹å‡†ç¡®ç‡ï¼ˆåŸºå‡†ï¼‰</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-value">${data.step2_accuracy}</div>
                        <div class="analysis-label">ä¼˜åŒ–åå‡†ç¡®ç‡</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-value">${data.actual_improvement}</div>
                        <div class="analysis-label">å®é™…æå‡å¹…åº¦</div>
                    </div>
                </div>

                <div class="alert ${data.meets_requirement.includes('âœ…') ? 'alert-success' : 'alert-info'}" style="margin-top: 30px;">
                    <strong>${data.meets_requirement}</strong>
                    ${data.samples_needed > 0 ? `<br>å»ºè®®è¿˜éœ€è¦æ”¶é›† ${data.samples_needed} ä¸ªæ ·æœ¬ä»¥è¾¾åˆ°ç›®æ ‡` : ''}
                </div>
            `;
        }

        // æ›´æ–°ä¸‹ä¸€æ­¥æ¨è
        function updateNextStepAnalysis(data) {
            console.log('updateNextStepAnalysis æ”¶åˆ°æ•°æ®:', data);
            const div = document.getElementById('nextStepAnalysis');

            if (!data) {
                console.error('æ²¡æœ‰æ”¶åˆ°æ•°æ®');
                div.innerHTML = `
                    <div class="strategy-box">
                        <h4>ğŸ“‹ ä¸‹ä¸€æ­¥æ¨è</h4>
                        <p style="margin: 20px 0;">æ²¡æœ‰æ”¶åˆ°æœåŠ¡å™¨å“åº”</p>
                    </div>
                `;
                return;
            }

            if (!data.recommendedProducts || data.recommendedProducts.length === 0) {
                console.log('æ²¡æœ‰æ¨èäº§å“ï¼Œæ•°æ®æ˜¾ç¤º:', data);
                div.innerHTML = `
                    <div class="strategy-box">
                        <h4>ğŸ“‹ ä¸‹ä¸€æ­¥æ¨è</h4>
                        <p style="margin: 20px 0;">${data?.analysis || 'éœ€è¦æ›´å¤šåé¦ˆæ•°æ®æ‰èƒ½ç”Ÿæˆæ¨è'}</p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                            <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
                            æ€»æ ·æœ¬æ•°: ${data?.analysis?.totalSamples || 0}<br>
                            æ­£æ ·æœ¬: ${data?.analysis?.positiveSamples || 0}<br>
                            è´Ÿæ ·æœ¬: ${data?.analysis?.negativeSamples || 0}<br>
                            æ¨èäº§å“æ•°: ${data?.recommendedProducts?.length || 0}
                        </div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="strategy-box">
                    <h4>ğŸš€ ${data.nextStep}</h4>
                    <div style="margin: 20px 0;">
                        <p><strong>ç­–ç•¥è¯´æ˜:</strong> ${data.strategy}</p>
                        <p><strong>æ¨èç½®ä¿¡åº¦:</strong> <span class="confidence-${data.confidence}">${data.confidence.toUpperCase()}</span></p>
                    </div>
                </div>

                <!-- ç”¨æˆ·åˆ†ææ´å¯Ÿ -->
                <div class="strategy-box" style="background: #f0f7ff; color: #333;">
                    <h4 style="color: #333;">ğŸ‘¤ ç”¨æˆ·åå¥½åˆ†æ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <strong>æ ·æœ¬ç»Ÿè®¡:</strong><br>
                            æ€»æ ·æœ¬: ${data.analysis.totalSamples}<br>
                            æ­£æ ·æœ¬: ${data.analysis.positiveSamples}<br>
                            è´Ÿæ ·æœ¬: ${data.analysis.negativeSamples}
                        </div>
                        <div>
                            <strong>é£é™©åå¥½:</strong> ${data.analysis.userPreferences.riskPreference}<br>
                            <strong>æŠ•èµ„è¡Œä¸º:</strong> ${data.analysis.userPreferences.investmentBehavior}
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>ç”¨æˆ·æ´å¯Ÿ:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #333; line-height: 1.6;">
                            ${data.analysis.insights.map(insight => `<li style="margin-bottom: 5px;">${insight}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <h4 style="margin: 30px 0 20px 0;">ğŸ“¦ æ–°äº§å“æ¨è</h4>
                <div class="recommendation-grid">
            `;

            data.recommendedProducts.forEach(product => {
                const confidenceClass = `confidence-${product.confidence}`;
                html += `
                    <div class="product-card" style="border-left: 5px solid ${getScoreColor(product.recommendationScore)};">
                        <div class="product-header">
                            <div class="product-name">${product.name}</div>
                            <div class="product-category">${product.category}</div>
                            <div class="${confidenceClass}" style="font-size: 12px;">${product.confidence.toUpperCase()}</div>
                        </div>

                        <div style="margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>æ¨èåˆ†æ•°:</span>
                                <strong style="color: ${getScoreColor(product.recommendationScore)}">${product.recommendationScore.toFixed(1)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>é£é™©ç­‰çº§:</span>
                                <span>${'â­'.repeat(product.riskLevel)}${'â˜†'.repeat(4-product.riskLevel)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>æœ€ä½é‡‘é¢:</span>
                                <span>Â¥${product.minAmount.toLocaleString()}</span>
                            </div>
                        </div>

                        <div style="margin: 15px 0;">
                            <strong>æ¨èç†ç”±:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px;">
                                ${product.reasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                        </div>

                        <div style="margin: 15px 0;">
                            <strong>è¯æ®æ”¯æŒ:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px; color: #666;">
                                ${product.evidence.map(evidence => `<li>${evidence}</li>`).join('')}
                            </ul>
                        </div>

                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <div style="font-size: 12px; color: #666;">
                                <strong>äº§å“ç‰¹å¾:</strong> ${product.features.join('ã€')}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            div.innerHTML = html;
        }

        // è·å–åˆ†æ•°å¯¹åº”çš„é¢œè‰²
        function getScoreColor(score) {
            if (score >= 85) return '#28a745';
            if (score >= 70) return '#ffc107';
            if (score >= 60) return '#fd7e14';
            return '#dc3545';
        }

        // è·å–ä¸‹ä¸€æ­¥äº§å“æ¨è
        async function getNextStepRecommendations() {
            console.log('ç‚¹å‡»äº†ä¸‹ä¸€æ­¥æ¨èæŒ‰é’®');

            const btn = document.getElementById('getNextRecommendationsBtn');
            btn.disabled = true;
            btn.textContent = 'æ­£åœ¨ç”Ÿæˆæ¨è...';

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·
                if (!currentCustomer) {
                    console.error('æ²¡æœ‰å½“å‰å®¢æˆ·æ•°æ®');
                    alert('è¯·å…ˆæœç´¢å¹¶åˆ†æå®¢æˆ·');
                    btn.disabled = false;
                    btn.textContent = 'è·å–ä¸‹ä¸€æ­¥æ¨è';
                    return;
                }

                console.log('æ­£åœ¨ä¸ºå®¢æˆ·', currentCustomer.cust_no, 'è¯·æ±‚ä¸‹ä¸€æ­¥æ¨è');

                // è·å–è¯¥å®¢æˆ·çš„æ ·æœ¬æ•°æ®
                const response = await fetch(`${API_BASE}/customers/${currentCustomer.cust_no}/next-recommendations`);
                console.log('APIå“åº”çŠ¶æ€:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ä¸‹ä¸€æ­¥æ¨èæ•°æ®:', data);

                // æ›´æ–°ä¸‹ä¸€æ­¥æ¨èé¡µé¢
                updateNextStepAnalysis(data);

            } catch (error) {
                console.error('è·å–ä¸‹ä¸€æ­¥æ¨èå¤±è´¥:', error);
                document.getElementById('nextStepAnalysis').innerHTML = `
                    <div class="alert" style="background: #ffebee; color: #c62828;">
                        <strong>è·å–æ¨èå¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¯ è·å–ä¸‹ä¸€æ­¥æ¨è';
            }
        }

        // åˆ‡æ¢æ ‡ç­¾
        function showTab(tabName, element) {
            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
            document.getElementById(tabName).classList.add('active');
            if (element) {
                element.classList.add('active');
            }
        }

        // é¡µé¢åŠ è½½
        window.onload = function() {
            console.log('æ™ºèƒ½æ¨èç³»ç»Ÿå·²å°±ç»ª');
            // è‡ªåŠ¨æœç´¢å¹¶åˆ†æé»˜è®¤å®¢æˆ·
            document.getElementById('customerId').value = 'CDB91DCCE198B10A522FE2AABF6A8D81';
            analyzeCustomer();
        };
    </script>
</body>
</html>